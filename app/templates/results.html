{% extends "base.html" %}

{% block title %}Search Results{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/results.css') }}">
{% endblock %}

{% block content %}
<div class="header">
    <a href="{{ url_for('main.home') }}" class="back-link">← Back to Home</a>
    <h1>Search Results for: {{ query }}</h1>
</div>

<!-- Search bar -->
<form action="{{ url_for('main.search') }}" method="GET" class="search-form">
    <input type="text" name="q" placeholder="Enter search term..." value="{{ query }}">
    <div class="search-options">
        <label class="checkbox-container">
            <input type="checkbox" name="substring" id="substring-checkbox" {% if substring %}checked{% endif %}>
            <span class="checkbox-label">Include partial word matches</span>
        </label>
        <label class="checkbox-container">
            <input type="checkbox" name="regex" id="regex-checkbox" {% if regex %}checked{% endif %}>
            <span class="checkbox-label">Use regex pattern</span>
        </label>
        <div class="input-container">
            <label for="max-results">Results per page:</label>
            <input type="number" name="max_results" id="max-results" value="{{ max_results }}" min="1" max="1000">
        </div>
    </div>
    <button type="submit">Search</button>
</form>

<div class="stats">
    {% if pagination.total_results > 0 %}
        Showing {{ (pagination.page - 1) * pagination.per_page + 1 }} to 
        {{ [pagination.page * pagination.per_page, pagination.total_results] | min }} 
        of {{ pagination.total_results }} results
    {% else %}
        No results found
    {% endif %}
    {% if search_duration %}
    <span class="duration">(search took {{ search_duration|round(2) }}ms)</span>
    {% endif %}
</div>

{% if pagination.total_pages > 1 %}
<div class="pagination">
    <div class="pagination-info">
        Page {{ pagination.page }} of {{ pagination.total_pages }}
    </div>
    <div class="pagination-controls">
        {% if pagination.has_prev %}
            <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=pagination.page-1) }}" class="pagination-btn">← Previous</a>
        {% else %}
            <span class="pagination-btn disabled">← Previous</span>
        {% endif %}
        
        {% set start_page = [1, pagination.page - 2] | max %}
        {% set end_page = [pagination.total_pages, start_page + 4] | min %}
        {% set start_page = [1, end_page - 4] | max %}
        
        {% if start_page > 1 %}
            <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=1) }}" class="pagination-btn">1</a>
            {% if start_page > 2 %}
                <span class="pagination-ellipsis">...</span>
            {% endif %}
        {% endif %}
        
        {% for p in range(start_page, end_page + 1) %}
            {% if p == pagination.page %}
                <span class="pagination-btn active">{{ p }}</span>
            {% else %}
                <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=p) }}" class="pagination-btn">{{ p }}</a>
            {% endif %}
        {% endfor %}
        
        {% if end_page < pagination.total_pages %}
            {% if end_page < pagination.total_pages - 1 %}
                <span class="pagination-ellipsis">...</span>
            {% endif %}
            <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=pagination.total_pages) }}" class="pagination-btn">{{ pagination.total_pages }}</a>
        {% endif %}
        
        {% if pagination.has_next %}
            <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=pagination.page+1) }}" class="pagination-btn">Next →</a>
        {% else %}
            <span class="pagination-btn disabled">Next →</span>
        {% endif %}
    </div>
</div>
{% endif %}

{% if results %}
<div class="export-controls">
    <a href="{{ url_for('export.export_results_csv', query=query) }}" class="btn btn-primary">
        Export All Results to CSV
    </a>
</div>

<div class="results">
    {% for source, source_results in results|groupby('source') %}
    <div class="source-group">
        <div class="source-header" onclick="toggleSource('{{ source }}')">
            <span class="toggle-icon" id="icon-{{ source }}">▶</span>
            <span class="source-title">{{ source }}</span>
            <span class="result-count">{{ source_results|length }} results</span>
            <div class="source-actions">
                <a href="{{ url_for('export.export_source_files', source=source, type='json') }}" class="btn btn-export">JSON</a>
                <a href="{{ url_for('export.export_source_files', source=source, type='audio') }}" class="btn btn-export">Audio</a>
            </div>
        </div>
        
        <div id="{{ source }}-results" class="source-results" style="display: none;">
            {% for result in source_results %}
            <div class="result-item" data-start="{{ result.start }}" data-source="{{ source }}">
                <div class="result-content">
                    <div class="result-audio">
                        <div class="audio-placeholder" 
                             data-source="{{ source|urlencode }}"
                             data-format="{{ available_files[source].audio_format }}"
                             data-start="{{ result.start }}">
                        </div>
                    </div>
                    <div class="result-text-container">
                        <p class="result-text">{{ result.text }}</p>
                        <div class="result-actions">
                            <a href="{{ url_for('export.export_segment', source=source, start=result.start, duration=10) }}" 
                               class="btn btn-export">Export Segment</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

{% if pagination.total_pages > 1 %}
<div class="pagination bottom-pagination">
    <div class="pagination-info">
        Page {{ pagination.page }} of {{ pagination.total_pages }}
    </div>
    <div class="pagination-controls">
        {% if pagination.has_prev %}
            <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=pagination.page-1) }}" class="pagination-btn">← Previous</a>
        {% else %}
            <span class="pagination-btn disabled">← Previous</span>
        {% endif %}
        
        {% set start_page = [1, pagination.page - 2] | max %}
        {% set end_page = [pagination.total_pages, start_page + 4] | min %}
        {% set start_page = [1, end_page - 4] | max %}
        
        {% if start_page > 1 %}
            <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=1) }}" class="pagination-btn">1</a>
            {% if start_page > 2 %}
                <span class="pagination-ellipsis">...</span>
            {% endif %}
        {% endif %}
        
        {% for p in range(start_page, end_page + 1) %}
            {% if p == pagination.page %}
                <span class="pagination-btn active">{{ p }}</span>
            {% else %}
                <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=p) }}" class="pagination-btn">{{ p }}</a>
            {% endif %}
        {% endfor %}
        
        {% if end_page < pagination.total_pages %}
            {% if end_page < pagination.total_pages - 1 %}
                <span class="pagination-ellipsis">...</span>
            {% endif %}
            <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=pagination.total_pages) }}" class="pagination-btn">{{ pagination.total_pages }}</a>
        {% endif %}
        
        {% if pagination.has_next %}
            <a href="{{ url_for('main.search', q=query, regex=regex, substring=substring, max_results=max_results, page=pagination.page+1) }}" class="pagination-btn">Next →</a>
        {% else %}
            <span class="pagination-btn disabled">Next →</span>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<p class="no-results">No results found</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/results.js') }}"></script>
<script>
    // Update toggle function to change icon
    function toggleSource(sourceId) {
        const resultsDiv = document.getElementById(sourceId + '-results');
        const icon = document.getElementById('icon-' + sourceId);
        
        if (resultsDiv.style.display === 'none') {
            resultsDiv.style.display = 'block';
            icon.textContent = '▼';
            icon.style.transform = 'rotate(0deg)';
            
            // Load audio players when section is expanded
            resultsDiv.querySelectorAll('.audio-placeholder').forEach(placeholder => {
                loadAudio(placeholder);
            });
        } else {
            resultsDiv.style.display = 'none';
            icon.textContent = '▶';
            icon.style.transform = 'rotate(0deg)';
        }
    }
</script>
{% endblock %} 