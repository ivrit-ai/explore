<!-- app/templates/results.html -->
{% extends "base.html" %}

{# ──────────────────────────────────────────────── #
   Page <head> additions
# ──────────────────────────────────────────────── #}
{% block title %}תוצאות חיפוש{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/results.css') }}">
{% if request_id %}
<meta name="request-id" content="{{ request_id }}">
{% endif %}
{% endblock %}

{# ──────────────────────────────────────────────── #
   Main content
# ──────────────────────────────────────────────── #}
{% block content %}

<div class="header">
  <a href="{{ url_for('main.home') }}" class="back-link">← חזרה לדף הבית</a>
  <h1>תוצאות חיפוש עבור: {{ query }}</h1>
</div>

{# ―― Search bar ―― #}
<form action="{{ url_for('main.search') }}" method="GET" class="search-form">
  <input type="text" name="q" placeholder="הזן מונח לחיפוש…" value="{{ query }}">
  <div class="search-options">
    <div class="search-mode-container compact">
      <label class="search-mode-label">סוג:</label>
      <div class="search-mode-options inline">
        <label class="radio-option">
          <input type="radio" name="search_mode" value="exact" {% if search_mode == 'exact' %}checked{% endif %}>
          <span>מדויק</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="search_mode" value="partial" {% if search_mode == 'partial' %}checked{% endif %}>
          <span>חלקי</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="search_mode" value="regex" {% if search_mode == 'regex' %}checked{% endif %}>
          <span>Regex</span>
        </label>
      </div>
    </div>
    <div class="input-container">
      <label for="max-results">תוצאות לעמוד:</label>
      <input type="number" name="max_results_per_page" id="max-results"
             value="{{ max_results_per_page|default(1000) }}" min="1" max="5000">
    </div>
  </div>
  <button type="submit">חיפוש</button>
</form>

{# ―― error message ―― #}
{% if error_message %}
<div class="error-message" style="background-color: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
  <strong>⚠️ {{ error_message }}</strong>
</div>
{% endif %}

{# ―― general stats ―― #}
<div class="stats">
  {% if pagination.total_results > 0 %}
    <span>נמצאו {{ pagination.total_results }} תוצאות</span>
  {% else %}
    לא נמצאו תוצאות
  {% endif %}
  {% if search_duration %}
    <span class="duration">(החיפוש ארך {{ search_duration|round(2) }} מילישניות)</span>
  {% endif %}
</div>

{# ―― top pagination bar ―― #}
{% include "partials/pagination.html" %}

{# ───────────────────────────────────────────── #
   Search results
# ───────────────────────────────────────────── #}
{% if results %}
<div class="results-container">
  {# ―― Side Panel for Filters ―― #}
  <aside id="filter-panel" class="filter-panel">
    <div class="filter-panel-header">
      <h2>סינון תוצאות</h2>
      <button id="filter-panel-toggle" class="filter-panel-toggle" aria-label="סגור/פתח פאנל סינון">×</button>
    </div>
    
    <div class="filter-panel-content">
      {# Date Range Filter #}
      <div class="filter-section">
        <h3>תאריכים</h3>
        <div class="filter-date-inputs">
          <label for="filter-date-from">מתאריך:</label>
          <input type="date" id="filter-date-from" class="filter-date-input">
        </div>
        <div class="filter-date-inputs">
          <label for="filter-date-to">עד תאריך:</label>
          <input type="date" id="filter-date-to" class="filter-date-input">
        </div>
      </div>

      {# Source Filter #}
      <div class="filter-section">
        <div class="filter-section-header">
          <h3>מקורות</h3>
          <button id="toggle-all-sources" class="btn-toggle-all" type="button">בטל הכל</button>
        </div>
        <div id="filter-sources" class="filter-sources-list">
          <div class="filter-loading">טוען מקורות...</div>
        </div>
      </div>

      {# Apply Filters Button #}
      <button id="apply-filters-btn" class="btn btn-apply-filters" type="button">החל סינון</button>

      {# Active Filters Indicator #}
      <div id="active-filters-indicator" class="active-filters-indicator" style="display: none;">
        <span id="active-filters-count">0</span> מסננים פעילים
      </div>

      {# Clear Filters Button #}
      <button id="clear-filters-btn" class="btn btn-clear-filters" style="display: none;">נקה כל המסננים</button>
    </div>
  </aside>

  {# ―― Main Content Area ―― #}
  <div class="results-main">
    <div class="export-controls">
      <button id="filter-panel-open" class="btn btn-filter-toggle">סינון תוצאות</button>
      <a href="{{ url_for('export.export_results_csv', q=query, search_mode=search_mode,
                          date_from=date_from, date_to=date_to, sources=sources_param) }}"
         class="btn btn-primary">ייצא את כל התוצאות ל-CSV</a>
    </div>

    <div class="results">

  {# group the flat results list by 'source' (== recording ID) #}
  {% for group in results %}
  {% set group_id = 'group-' ~ loop.index %}
  <div class="source-group" data-source="{{ group.source }}" data-episode-date="{{ group.episode_date }}">

    <div class="source-header"
      onclick='toggleSource("{{ group_id }}")'>
      <span class="toggle-icon" id="icon-{{ group_id }}">▶</span>

      <!-- put all textual meta in one wrapper so Flex/Grid can treat it as a unit -->
      <div class="meta">
        <span class="source-title">{{ group.source|replace('/', ': ') }}</span>
        <span class="episode-title">{{ group.episode_title }}</span>
        <span class="episode-date">{{ group.episode_date }}</span>
      </div>

      <!-- compact counter badge -->
      <span class="result-count">{{ group.results|length }} תוצאות</span>

      <!-- leave the player placeholder last so it hugs the left in RTL -->
      <div class="audio-container source-audio-container"
           data-uuid="{{ group.uuid }}"
           data-format="opus"
           data-start="{{ group.results[0].start_sec if group.results else 0 }}"
           data-end="{{ group.results[-1].end_sec if group.results else 0 }}">
      </div>
    </div>


    {# ─────── individual hits for this source ─────── #}
    <div id="{{ group_id }}-results" style="display:none">
      {% for result in group.results %}
      <div class="result-item"
           data-uuid="{{ group.uuid }}"
           data-epi="{{ result.episode_idx }}"
           data-char="{{ result.char_offset }}"
           data-seg="{{ result.segment_idx }}"
           data-start="{{ '%.2f' | format(result.start_sec) }}"
           data-end="{{ '%.2f' | format(result.end_sec) }}">

        <div class="result-content">
          <div class="result-text-container">
            <div class="result-actions">
              <a href="{{ url_for('export.export_segment',
                                source=group.episode.split('/')[0],
                                filename=group.episode.split('/')[1] if '/' in group.episode else group.episode,
                                start=result.start_sec,
                                end=result.end_sec) }}"
                 class="btn btn-export">ייצא אודיו</a>
            </div>
            <div class="context-container loading">טוען...</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>  {# /#results #}

  </div>      {# /.source-group #}
  {% endfor %}
    </div>          {# /.results #}
  </div>  {# /.results-main #}
</div>  {# /.results-container #}

{% else %}
<p class="no-results">לא נמצאו תוצאות</p>
{% endif %}

{# ―― bottom pagination bar (identical to top) ―― #}
{% include "partials/pagination.html" %}

{% endblock %}  {# /content #}

{# ──────────────────────────────────────────────── #
   JS assets
# ──────────────────────────────────────────────── #}
{% block scripts %}
<script src="{{ url_for('static', filename='js/results.js') }}"></script>
<script src="{{ url_for('static', filename='js/filters.js') }}"></script>
<script>
function toggleSource(sourceId) {
  const resultsDiv  = document.getElementById(sourceId + '-results');
  const icon        = document.getElementById('icon-' + sourceId);
  const sourceHeader= document.querySelector(`.source-header[onclick*="${sourceId}"]`);

  if (resultsDiv.style.display === 'none') {
    resultsDiv.style.display = 'block';
    icon.textContent = '▼';

    /* lazily load audio player */
    const ph = sourceHeader.querySelector('.audio-container');
    if (ph && ph.classList.contains('audio-container')) {
      loadAudio(ph);
    }

    /* ensure header is visible */
    if (!isInViewport(sourceHeader)) {
      sourceHeader.scrollIntoView({behavior:'smooth', block:'start'});
    }
  } else {
    resultsDiv.style.display = 'none';
    icon.textContent = '▶';
  }
}

function isInViewport(el) {
  const r = el.getBoundingClientRect();
  return (
    r.top    >= 0 &&
    r.left   >= 0 &&
    r.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
    r.right  <= (window.innerWidth  || document.documentElement.clientWidth)
  );
}
</script>
{% endblock %}
